<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multimodal AI Gateway Desktop</title>
    <style>
        :root {
            --dark-bg: #0a0a0f;
            --dark-card: #14141f;
            --dark-border: #2a2a3c;
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--dark-card);
            border-right: 1px solid var(--dark-border);
            padding: 24px;
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
        }
        
        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .logo-text {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-section {
            margin-bottom: 32px;
        }
        
        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            font-weight: 500;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        
        .header {
            margin-bottom: 32px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .header p {
            color: var(--text-secondary);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .stat-icon.apps { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .stat-icon.images { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
        .stat-icon.ollama { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .stat-icon.health { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Communication Channels */
        .channels-section {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .channel-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        
        .channel-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s;
        }
        
        .channel-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .channel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .channel-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .channel-icon.human { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .channel-icon.deepseek { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
        .channel-icon.ai { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
        
        .channel-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .channel-desc {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        
        .channel-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 12px;
        }
        
        .channel-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .channel-btn {
            width: 100%;
            padding: 10px;
            background: var(--primary);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .channel-btn:hover {
            background: var(--primary-hover);
        }
        
        /* Image Generation Section */
        .image-generation-section {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .image-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .control-btn {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-secondary);
        }
        
        .control-btn.image-btn {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(139, 92, 246, 0.1));
            border-color: rgba(168, 85, 247, 0.3);
            color: #a855f7;
        }
        
        .control-btn.image-btn:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(139, 92, 246, 0.2));
            border-color: #a855f7;
            color: white;
        }
        
        .image-options {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .option-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .image-input-group {
            display: flex;
            gap: 8px;
        }
        
        .image-prompt-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
        }
        
        .image-prompt-input:focus {
            border-color: #a855f7;
            outline: none;
        }
        
        .small-btn {
            padding: 8px 12px;
            background: var(--dark-border);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
        }
        
        .small-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .image-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .image-stat {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            padding: 8px;
            text-align: center;
        }
        
        .image-stat .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #a855f7;
            display: block;
        }
        
        .image-stat .stat-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        /* Logs Section */
        .logs-section {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 24px;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .logs-container {
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 12px;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-icon {
            flex-shrink: 0;
        }
        
        .log-content {
            flex: 1;
        }
        
        .log-time {
            color: var(--text-muted);
            font-size: 10px;
        }
        
        .log-text {
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* Image Modal */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .image-modal-content {
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
        }
        
        .image-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .image-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .image-modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .image-prompt-display {
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        
        .image-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .image-action-btn {
            padding: 10px 16px;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .image-action-btn.primary {
            background: #a855f7;
            border-color: #a855f7;
            color: white;
        }
        
        .image-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .image-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--dark-border);
            background: var(--dark-bg);
        }
        
        .image-next-steps {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        
        .log-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }
        
        .log-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-icon">🤖</div>
                <div class="logo-text">AI Gateway</div>
            </div>
            
            <div class="nav-section">
                <div class="section-title">Navigation</div>
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <span>📊</span> Dashboard
                </div>
                <div class="nav-item" onclick="showSection('apps')">
                    <span>📱</span> App Generation
                </div>
                <div class="nav-item" onclick="showSection('images')">
                    <span>🎨</span> Image Generation
                </div>
                <div class="nav-item" onclick="showSection('workflows')">
                    <span>🔄</span> Workflows
                </div>
                <div class="nav-item" onclick="showSection('logs')">
                    <span>📋</span> Activity Logs
                </div>
            </div>
            
            <div class="nav-section">
                <div class="section-title">AI Services</div>
                <div class="nav-item">
                    <span>🦙</span> Ollama (Local)
                </div>
                <div class="nav-item">
                    <span>🤖</span> DeepSeek
                </div>
                <div class="nav-item">
                    <span>⚡</span> Stable Diffusion
                </div>
            </div>
            
            <div class="nav-section" style="margin-top: auto;">
                <div class="nav-item" onclick="checkHealth()">
                    <span>❤️</span> Health Check
                </div>
                <div class="nav-item" onclick="clearLogs()">
                    <span>🗑️</span> Clear Logs
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section-content">
                <div class="header">
                    <h1>Multimodal AI Gateway</h1>
                    <p>Local AI orchestration system with app and image generation</p>
                </div>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon apps">📱</div>
                            <div class="stat-value" id="appsCount">0</div>
                        </div>
                        <div class="stat-label">Apps Generated</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon images">🎨</div>
                            <div class="stat-value" id="imagesCount">0</div>
                        </div>
                        <div class="stat-label">Image Prompts</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon ollama">🦙</div>
                            <div class="stat-value" id="ollamaStatus">Ready</div>
                        </div>
                        <div class="stat-label">Ollama Status</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon health">❤️</div>
                            <div class="stat-value" id="healthStatus">OK</div>
                        </div>
                        <div class="stat-label">Gateway Health</div>
                    </div>
                </div>
                
                <!-- Communication Channels -->
                <div class="channels-section">
                    <div class="section-title">Communication Channels</div>
                    <div class="channel-cards">
                        <div class="channel-card">
                            <div class="channel-header">
                                <div class="channel-icon human">👤</div>
                                <div class="channel-title">Human Input</div>
                            </div>
                            <div class="channel-desc">Generate React Native apps from your descriptions</div>
                            <input type="text" class="channel-input" id="humanInput" placeholder="Describe an app you want to create...">
                            <button class="channel-btn" onclick="sendHumanRequest()">Generate App</button>
                        </div>
                        
                        <div class="channel-card">
                            <div class="channel-header">
                                <div class="channel-icon deepseek">🤖</div>
                                <div class="channel-title">DeepSeek AI</div>
                            </div>
                            <div class="channel-desc">Process DeepSeek AI responses into apps</div>
                            <input type="text" class="channel-input" id="deepseekInput" placeholder="Paste DeepSeek response...">
                            <button class="channel-btn" onclick="sendDeepSeekRequest()">Process AI Response</button>
                        </div>
                        
                        <div class="channel-card">
                            <div class="channel-header">
                                <div class="channel-icon ai">⚡</div>
                                <div class="channel-title">Any AI Source</div>
                            </div>
                            <div class="channel-desc">Process any AI response into apps</div>
                            <input type="text" class="channel-input" id="aiInput" placeholder="Enter AI response...">
                            <button class="channel-btn" onclick="sendAIRequest()">Process Response</button>
                        </div>
                    </div>
                </div>
                
                <!-- Image Generation Section -->
                <div class="image-generation-section">
                    <div class="section-title">Image Generation</div>
                    
                    <div class="image-controls">
                        <button class="control-btn image-btn" onclick="generateImageFromText()" id="generateImageBtn">
                            <span>🎨</span>
                            Generate Image
                        </button>
                        
                        <button class="control-btn secondary" onclick="openImagePrompts()" id="viewPromptsBtn">
                            <span>📋</span>
                            View Prompts
                        </button>
                    </div>
                    
                    <div class="image-options">
                        <div class="option-group">
                            <label class="option-label">
                                <input type="radio" name="imageSource" value="direct" checked onchange="updateImageSource()">
                                Direct Prompt
                            </label>
                            <label class="option-label">
                                <input type="radio" name="imageSource" value="ollama" onchange="updateImageSource()">
                                Ollama Enhanced
                            </label>
                            <label class="option-label">
                                <input type="radio" name="imageSource" value="workflow" onchange="updateImageSource()">
                                Full Workflow
                            </label>
                        </div>
                        
                        <div class="image-input-group">
                            <input type="text" class="image-prompt-input" id="imagePromptInput" 
                                   placeholder="Describe the image you want to generate...">
                            <button class="small-btn" onclick="insertExamplePrompt()">Example</button>
                        </div>
                    </div>
                    
                    <div class="image-stats">
                        <div class="image-stat">
                            <span class="stat-value" id="imageCount">0</span>
                            <span class="stat-label">Prompts</span>
                        </div>
                        <div class="image-stat">
                            <span class="stat-value" id="imageTools">0</span>
                            <span class="stat-label">Tools</span>
                        </div>
                    </div>
                </div>
                
                <!-- Logs Section -->
                <div class="logs-section">
                    <div class="logs-header">
                        <div class="section-title">Activity Log</div>
                        <button class="small-btn" onclick="clearLogs()">Clear</button>
                    </div>
                    <div class="logs-container" id="logsContainer">
                        <div class="log-entry">
                            <div class="log-icon">🚀</div>
                            <div class="log-content">
                                <div class="log-time">System</div>
                                <div class="log-text">Multimodal AI Gateway initialized</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // Global variables
        let currentLogs = [];
        let currentSection = 'dashboard';
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            checkHealth();
            updateStats();
            setInterval(updateStats, 10000); // Update every 10 seconds
        });
        
        // Section navigation
        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            currentSection = section;
            // In a real app, you would show/hide different sections
            addLog(`Switched to ${section} section`, 'system');
        }
        
        // Communication functions
        async function sendHumanRequest() {
            const input = document.getElementById('humanInput').value.trim();
            if (!input) {
                addLog('Please enter a description', 'error');
                return;
            }
            
            addLog(`Human request: ${input}`, 'human');
            
            try {
                const response = await fetch('http://localhost:3003/api/human/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: input, 
                        session_id: `human_${Date.now()}` 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`✅ App generated: ${result.file}`, 'success');
                    addLog(`Download: ${result.download_url}`, 'info');
                    document.getElementById('humanInput').value = '';
                } else {
                    addLog(`❌ Failed: ${result.error}`, 'error');
                }
                
                updateStats();
                
            } catch (error) {
                addLog(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function sendDeepSeekRequest() {
            const input = document.getElementById('deepseekInput').value.trim();
            if (!input) {
                addLog('Please enter DeepSeek response', 'error');
                return;
            }
            
            addLog(`DeepSeek request: ${input.substring(0, 50)}...`, 'deepseek');
            
            try {
                const response = await fetch('http://localhost:3003/api/deepseek/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: input, 
                        session_id: `deepseek_${Date.now()}` 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`✅ DeepSeek app generated: ${result.file}`, 'success');
                    document.getElementById('deepseekInput').value = '';
                } else {
                    addLog(`❌ Failed: ${result.error}`, 'error');
                }
                
                updateStats();
                
            } catch (error) {
                addLog(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function sendAIRequest() {
            const input = document.getElementById('aiInput').value.trim();
            if (!input) {
                addLog('Please enter AI response', 'error');
                return;
            }
            
            addLog(`AI request: ${input.substring(0, 50)}...`, 'ai');
            
            try {
                const response = await fetch('http://localhost:3003/api/ai/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: input, 
                        session_id: `ai_${Date.now()}`,
                        source: 'desktop'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog(`✅ AI app generated: ${result.file}`, 'success');
                    document.getElementById('aiInput').value = '';
                } else {
                    addLog(`❌ Failed: ${result.error}`, 'error');
                }
                
                updateStats();
                
            } catch (error) {
                addLog(`Network error: ${error.message}`, 'error');
            }
        }
        
        // Image generation functions
        async function generateImageFromText() {
            const promptInput = document.getElementById('imagePromptInput');
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                addLog('Please enter an image description', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generateImageBtn');
            const originalText = generateBtn.textContent;
            
            generateBtn.textContent = 'Generating...';
            generateBtn.disabled = true;
            
            // Determine which endpoint to use
            const imageSource = document.querySelector('input[name="imageSource"]:checked').value;
            let endpoint, payload;
            
            switch(imageSource) {
                case 'direct':
                    endpoint = '/api/generate/image';
                    payload = { prompt, source: 'desktop', session_id: `img_${Date.now()}` };
                    break;
                case 'ollama':
                    endpoint = '/api/ollama/generate';
                    payload = { prompt, session_id: `ollama_img_${Date.now()}`, model: 'llama3' };
                    break;
                case 'workflow':
                    endpoint = '/api/workflow/text-to-image';
                    payload = { text: prompt, steps: 2, session_id: `workflow_${Date.now()}` };
                    break;
            }
            
            try {
                const response = await fetch(`http://localhost:3003${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear input
                    promptInput.value = '';
                    
                    // Show image generation result
                    showImageResult(result, prompt);
                    
                    // Add to log
                    addLog(`🎨 Image ${imageSource} request: ${prompt.substring(0, 50)}...`, 'image');
                    
                    // Update stats
                    updateImageStats();
                    
                } else {
                    addLog(`Image generation failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLog(`Image generation error: ${error.message}`, 'error');
            } finally {
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }
        
        function showImageResult(result, originalPrompt) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'image-modal active';
            
            let promptContent = result.prompt || originalPrompt;
            let actionsHTML = '';
            
            if (result.prompt_url) {
                actionsHTML += `
                    <button class="image-action-btn" onclick="copyImagePrompt('${result.prompt_url}')">
                        📋 Copy Prompt
                    </button>
                    <button class="image-action-btn" onclick="viewImagePrompt('${result.prompt_url}')">
                        👁️ View Prompt
                    </button>
                `;
            }
            
            if (result.tools_available && result.tools_available.length > 0) {
                actionsHTML += `
                    <button class="image-action-btn primary" onclick="openImageToolsGuide()">
                        🛠️ Setup Tools
                    </button>
                `;
            }
            
            modal.innerHTML = `
                <div class="image-modal-content">
                    <div class="image-modal-header">
                        <h3><span>🎨</span> Image Generation Ready</h3>
                        <button class="log-close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
                    </div>
                    
                    <div class="image-modal-body">
                        <p><strong>Original request:</strong> ${originalPrompt}</p>
                        
                        <div class="image-prompt-display">
${promptContent}
                        </div>
                        
                        <div class="image-actions">
                            ${actionsHTML}
                            <button class="image-action-btn" onclick="saveImagePrompt()">
                                💾 Save Prompt
                            </button>
                        </div>
                    </div>
                    
                    <div class="image-modal-footer">
                        <div class="image-next-steps">
                            <strong>Next steps:</strong><br>
                            1. Copy the prompt above<br>
                            2. Use with your preferred image generator<br>
                            3. ${result.tools_available ? `Available tools: ${result.tools_available.join(', ')}` : 'Install Stable Diffusion or DALL-E for automatic generation'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        async function copyImagePrompt(promptUrl) {
            try {
                const response = await fetch(`http://localhost:3003${promptUrl}`);
                const promptText = await response.text();
                
                await navigator.clipboard.writeText(promptText);
                
                // Show success message
                showNotification('Image prompt copied to clipboard!');
                
            } catch (error) {
                console.error('Failed to copy prompt:', error);
                showNotification('Failed to copy prompt', 'error');
            }
        }
        
        function viewImagePrompt(promptUrl) {
            window.open(`http://localhost:3003${promptUrl}`, '_blank');
        }
        
        function openImageToolsGuide() {
            window.open('https://github.com/AUTOMATIC1111/stable-diffusion-webui/wiki/Install-and-Run', '_blank');
        }
        
        async function saveImagePrompt() {
            const modal = document.querySelector('.image-modal .image-prompt-display');
            if (modal) {
                const prompt = modal.textContent;
                
                const blob = new Blob([prompt], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `image_prompt_${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showNotification('Prompt saved as file!');
            }
        }
        
        function insertExamplePrompt() {
            const examples = [
                "A serene mountain landscape at sunset with a lake reflecting the sky",
                "Cyberpunk street scene with neon signs and flying cars",
                "Futuristic city with towering skyscrapers and hovering vehicles",
                "Magical forest with glowing mushrooms and fairy lights",
                "Minimalist office space with modern furniture and plants"
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            document.getElementById('imagePromptInput').value = randomExample;
        }
        
        async function openImagePrompts() {
            try {
                const response = await fetch('http://localhost:3003/api/image/prompts');
                const data = await response.json();
                
                showPromptsModal(data.prompts);
                
            } catch (error) {
                addLog('Could not load image prompts', 'error');
            }
        }
        
        function showPromptsModal(prompts) {
            const modal = document.createElement('div');
            modal.className = 'image-modal active';
            
            let promptsHTML = '';
            if (prompts && prompts.length > 0) {
                prompts.forEach(prompt => {
                    const date = new Date(prompt.created).toLocaleString();
                    promptsHTML += `
                        <div class="prompt-item" style="background: var(--dark-bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--dark-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; font-size: 12px;">${prompt.name}</div>
                                    <div style="font-size: 10px; color: var(--text-muted);">${date}</div>
                                </div>
                                <div style="display: flex; gap: 6px;">
                                    <button class="small-btn" onclick="loadPrompt('${prompt.name}')">Load</button>
                                    <button class="small-btn" onclick="deletePrompt('${prompt.name}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                promptsHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No prompts found</p>';
            }
            
            modal.innerHTML = `
                <div class="image-modal-content">
                    <div class="image-modal-header">
                        <h3><span>📋</span> Saved Image Prompts</h3>
                        <button class="log-close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
                    </div>
                    
                    <div class="image-modal-body">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${promptsHTML}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function loadPrompt(promptName) {
            try {
                const response = await fetch(`http://localhost:3003/api/image/prompt/${promptName}`);
                const promptText = await response.text();
                
                // Set as current prompt
                document.getElementById('imagePromptInput').value = promptText;
                
                // Close modal
                document.querySelector('.image-modal').remove();
                
                showNotification('Prompt loaded!');
                
            } catch (error) {
                showNotification('Failed to load prompt', 'error');
            }
        }
        
        async function deletePrompt(promptName) {
            if (confirm('Delete this prompt?')) {
                try {
                    const response = await fetch(`http://localhost:3003/api/image/prompt/${promptName}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('Prompt deleted');
                        openImagePrompts(); // Refresh the modal
                        updateImageStats();
                    }
                    
                } catch (error) {
                    showNotification('Failed to delete prompt', 'error');
                }
            }
        }
        
        function updateImageSource() {
            const source = document.querySelector('input[name="imageSource"]:checked').value;
            addLog(`Image generation mode: ${source}`, 'system');
        }
        
        // Health and stats functions
        async function checkHealth() {
            try {
                const response = await fetch('http://localhost:3003/api/health');
                const data = await response.json();
                
                document.getElementById('healthStatus').textContent = data.status;
                document.getElementById('healthStatus').style.color = data.status === 'operational' ? '#22c55e' : '#ef4444';
                
                addLog(`Gateway health: ${data.status}`, 'system');
                
                // Update Ollama status
                document.getElementById('ollamaStatus').textContent = 'Ready';
                document.getElementById('ollamaStatus').style.color = '#22c55e';
                
            } catch (error) {
                document.getElementById('healthStatus').textContent = 'Offline';
                document.getElementById('healthStatus').style.color = '#ef4444';
                addLog('Gateway is offline', 'error');
            }
        }
        
        async function updateStats() {
            try {
                const response = await fetch('http://localhost:3003/api/health');
                const data = await response.json();
                
                document.getElementById('appsCount').textContent = data.apps_generated || 0;
                document.getElementById('imagesCount').textContent = data.images_generated || 0;
                
                // Update image tools
                if (data.image_tools) {
                    document.getElementById('imageTools').textContent = data.image_tools.length;
                }
                
            } catch (error) {
                // Silently fail
            }
        }
        
        async function updateImageStats() {
            try {
                const response = await fetch('http://localhost:3003/api/image/prompts');
                const data = await response.json();
                
                document.getElementById('imageCount').textContent = data.total || 0;
                
            } catch (error) {
                // Silently fail
            }
        }
        
        // Log functions
        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('logsContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            const icons = {
                'info': 'ℹ️',
                'success': '✅',
                'error': '❌',
                'warning': '⚠️',
                'human': '👤',
                'deepseek': '🤖',
                'ai': '⚡',
                'system': '🖥️',
                'image': '🎨'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <div class="log-icon">${icons[type] || 'ℹ️'}</div>
                <div class="log-content">
                    <div class="log-time">${timestamp}</div>
                    <div class="log-text">${message}</div>
                </div>
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            // Keep only last 50 logs
            const entries = logsContainer.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                entries[0].remove();
            }
        }
        
        function clearLogs() {
            const logsContainer = document.getElementById('logsContainer');
            logsContainer.innerHTML = '';
            addLog('Logs cleared', 'system');
        }
        
        // Notification function
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#10b981'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 9999;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.3s ease;
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Add animation keyframes if not present
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @keyframes slideOut {
                        from {
                            transform: translateX(0);
                            opacity: 1;
                        }
                        to {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 3000);
        }
    </script>
</body>
</html>
