const express=require("express");const axios=require("axios");const fs=require("fs").promises;const path=require("path");const app=express();app.use(express.json());const OLLAMA_URL="http://localhost:11434/api/generate";const MODEL="tinyllama";const WORKSPACE=path.join(__dirname,"ai_workspace");["projects","logs","instructions"].forEach(dir=>{require("fs").mkdirSync(path.join(WORKSPACE,dir),{recursive:true})});async function queryOllama(prompt){try{console.log("Querying Ollama...");const response=await axios.post(OLLAMA_URL,{model:MODEL,prompt:"Create React Native app: "+prompt+". Return only code.",stream:false,options:{temperature:0.7,num_predict:2000}},{timeout:60000});console.log("Ollama response received");return response.data.response;}catch(error){console.error("Ollama failed:",error.message);return `// Mock app\nimport React from "react";\nimport {View,Text,StyleSheet} from "react-native";\n\nexport default function App(){\n return (\n  <View style={styles.container}>\n   <Text>App: ${prompt.substring(0,50)}...</Text>\n  </View>\n );\n}\n\nconst styles=StyleSheet.create({\n container:{flex:1,justifyContent:"center",alignItems:"center"}\n});`;}}function extractCode(content){const codeMatch=content.match(/```(?:javascript|jsx?)\n([\s\S]*?)\n```/);return codeMatch?codeMatch[1]:content;}app.post("/api/ai/process",async(req,res)=>{try{const{message,session_id}=req.body;console.log("AI:",message);const ollamaResponse=await queryOllama(message);const appCode=extractCode(ollamaResponse);const filename="app_"+(session_id||Date.now())+".js";const filepath=path.join(WORKSPACE,"projects",filename);await fs.writeFile(filepath,appCode);res.json({success:true,source:"Ollama",file:filename,preview:appCode.substring(0,100)+"...",timestamp:new Date().toISOString()});}catch(error){console.error("Error:",error);res.status(500).json({error:error.message});}});app.get("/api/health",async(req,res)=>{try{await axios.get("http://localhost:11434/api/tags",{timeout:5000});res.json({status:"OK",ollama:"online",model:MODEL});}catch{res.json({status:"OK",ollama:"offline",model:MODEL});}});app.get("/api/workspace",async(req,res)=>{try{const files=await fs.readdir(path.join(WORKSPACE,"projects"));res.json({count:files.length,files:files});}catch(error){res.json({error:error.message});}});const PORT=process.env.PORT||3003;app.listen(PORT,()=>{console.log("?? AI Gateway with Ollama on port "+PORT);console.log("Test: curl http://localhost:"+PORT+"/api/health");});
